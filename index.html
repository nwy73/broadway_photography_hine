<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Broadway Vector Tiles</title>
  <link href="https://unpkg.com/maplibre-gl@^5.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Jacques+Francois&display=swap" rel="stylesheet">
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    #map-container {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      z-index: 0;
    }

    #slider-container {
      font-family: 'Jacques Francois', serif;
      background-color: #f9f7f1;
      border: 1px solid #ccc;
      padding: 12px;
      width: 280px;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #opacity-slider label,
    #time-slider label {
      display: block;
      font-size: 0.9em;
      margin-bottom: 6px;
      color: #555;
    }

    input[type="range"] {
      width: 100%;
    }

    /* Labels left and right of slider */
    #opacity-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      margin-bottom: 6px;
      user-select: none;
      color: #555;
    }

    #time-year {
      font-size: 0.9em;
      margin-left: 8px;
      color: #555;
    }

  </style>
</head>

<body>
  <div id="map-container">
    <div id="map"></div>
  </div>

  <div id="slider-container">
    <div id="opacity-slider">
      <div id="opacity-labels">
        <span>Historic Map</span>
        <span>Contemporary Map</span>
      </div>
      <input type="range" id="slider" min="0" max="100" value="0" />
    </div>

    <div id="time-slider">
      <label for="time-slider-input">Historic Progression of Broadway</label>
      <input type="range" id="time-slider-input" min="1776" max="1906" value="1776" step="1" />
      <span id="time-year">1776</span>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@^5.6.2/dist/maplibre-gl.js"></script>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: 'assets/styles/style.json',
      center: [-73.96, 40.785],
      zoom: 11
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-left');

    // Global variable to store the original GeoJSON
    let originalGeoJsonData = null;

    map.on('load', () => {

      const timeSlider = document.getElementById('time-slider-input');
      const timeYear = document.getElementById('time-year');
      const slider = document.getElementById("slider");

      timeSlider.value = 1776;
      timeYear.textContent = '1776';

      // Add Voyager raster layer
      map.addSource('voyager', {
        type: 'raster',
        tiles: ['https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'],
        tileSize: 256
      });

      map.addLayer({
        id: 'voyager-raster-layer',
        type: 'raster',
        source: 'voyager',
        paint: {
          'raster-opacity': 1  // start fully visible (contemporary)
        }
      }, 'paper-fibers-layer');

      // Load Broadway_History.geojson via fetch to preserve original data
      fetch('overlays/Broadway_History.geojson')
        .then(response => response.json())
        .then(data => {
          originalGeoJsonData = data; // Store original full data

          const initialYear = parseInt(timeSlider.value, 10);
          const filteredGeoJson = filterByYear(initialYear);

          map.addSource('broadway-history', {
            type: 'geojson',
            data: filteredGeoJson
          });

          map.addLayer({
            id: 'broadway-history-layer',
            type: 'line',
            source: 'broadway-history',
            paint: {
              'line-color': '#8B5E3C',
              'line-width': 3,
              'line-opacity': 1
            }
          });
        });

      // Store original opacities for layers
      const originalOpacities = {};

      map.once('idle', () => {
        map.getStyle().layers.forEach(layer => {
          const { id, source, type } = layer;

          if (source === 'broadway') {
            const props = {};
            if (type === 'fill') {
              const opacity = map.getPaintProperty(id, 'fill-opacity');
              props['fill-opacity'] = opacity !== undefined ? opacity : 1;
            } else if (type === 'line') {
              const opacity = map.getPaintProperty(id, 'line-opacity');
              props['line-opacity'] = opacity !== undefined ? opacity : 1;
            } else if (type === 'symbol') {
              const textOpacity = map.getPaintProperty(id, 'text-opacity');
              const iconOpacity = map.getPaintProperty(id, 'icon-opacity');
              props['text-opacity'] = textOpacity !== undefined ? textOpacity : 1;
              props['icon-opacity'] = iconOpacity !== undefined ? iconOpacity : 1;
            }
            if (Object.keys(props).length) {
              originalOpacities[id] = props;
            }
          }

          if (id === 'paper-fibers-layer' && type === 'raster') {
            const rasterOpacity = map.getPaintProperty(id, 'raster-opacity');
            originalOpacities[id] = {
              'raster-opacity': rasterOpacity !== undefined ? rasterOpacity : 1
            };
          }
        });

        // Initialize slider value at 0 (full historic opacity)
        // multiplier is 1 - slider.value/100
        const multiplier = 1 - (slider.value / 100);

        Object.entries(originalOpacities).forEach(([layerId, props]) => {
          if (layerId === 'voyager-raster-layer') return;

          Object.entries(props).forEach(([property, originalValue]) => {
            map.setPaintProperty(layerId, property, originalValue * multiplier);
          });
        });

        // Voyager opacity inverse
        const voyagerOpacity = 1 - multiplier;
        if (map.getLayer('voyager-raster-layer')) {
          map.setPaintProperty('voyager-raster-layer', 'raster-opacity', voyagerOpacity);
        }

      });

      slider.addEventListener("input", () => {
        const value = parseInt(slider.value, 10);
        const multiplier = 1 - (value / 100);

        Object.entries(originalOpacities).forEach(([layerId, props]) => {
          if (layerId === 'voyager-raster-layer') return;

          Object.entries(props).forEach(([property, originalValue]) => {
            map.setPaintProperty(layerId, property, originalValue * multiplier);
          });
        });

        const voyagerOpacity = 1 - multiplier;
        if (map.getLayer('voyager-raster-layer')) {
          map.setPaintProperty('voyager-raster-layer', 'raster-opacity', voyagerOpacity);
        }
      });

      timeSlider.addEventListener('input', () => {
        const year = parseInt(timeSlider.value, 10);
        timeYear.textContent = `${year}`;

        if (map.getSource('broadway-history')) {
          map.getSource('broadway-history').setData(filterByYear(year));
        }
      });
    });

    function filterByYear(year) {
      if (!originalGeoJsonData) return { type: 'FeatureCollection', features: [] };

      const filteredFeatures = originalGeoJsonData.features.filter(feature => {
        const { syear, eyear } = feature.properties;
        return year >= syear && year <= eyear;
      });

      return {
        type: 'FeatureCollection',
        features: filteredFeatures
      };
    }
  </script>
</body>

</html>
